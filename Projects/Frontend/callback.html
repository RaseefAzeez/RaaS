<!DOCTYPE html>
<html>

<head>
  <title>Callback</title>
</head>

<body>
  <p>Logging you inâ€¦</p>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
      document.body.innerText = "No authorization code found.";
      throw new Error("No code");
    }

    const tokenEndpoint =
      "https://us-east-1ddyxzzaiw.auth.us-east-1.amazoncognito.com/oauth2/token";

    const clientId = "5g8gugkm6cre8sjll45kjii9q6";
    const redirectUri = "https://d1l62wn91r29l3.cloudfront.net/callback.html";

    const verifier = sessionStorage.getItem("pkce_verifier");

    if (!verifier) {
      document.body.innerText = "PKCE verifier missing.";
      throw new Error("Missing PKCE verifier");
    }

    fetch(tokenEndpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        grant_type: "authorization_code",
        client_id: clientId,
        code: code,
        redirect_uri: redirectUri,
        code_verifier: verifier   // ðŸ”´ REQUIRED
      })
    })
      .then(async res => {
        const text = await res.text();
        if (!res.ok) throw new Error(text);
        return JSON.parse(text);
      })
      .then(data => {
        sessionStorage.setItem("access_token", data.access_token);
        window.location.href = "index.html";
      })
      .catch(err => {
        console.error(err);
        document.body.innerText = "Login failed. Check console.";
      });

  </script>
</body>

</html>